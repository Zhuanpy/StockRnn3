{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>股票分钟数据记录管理</h1>
        <p class="subtitle">管理股票分钟数据下载记录</p>
        <button class="btn btn-primary" onclick="showAddModal()">
            <i class="fas fa-plus"></i> 添加新记录
        </button>
    </div>

    <!-- 搜索和筛选 -->
    <div class="search-section">
        <form id="searchForm" method="get" action="{{ url_for('data_bp.record_stock_minute') }}" style="display:flex;gap:10px;">
            <input type="text" id="searchInput" name="search" placeholder="搜索股票代码、名称或ID..." value="{{ request.args.get('search', '') }}">
            <button class="btn btn-primary" type="submit">搜索</button>
            <button class="btn btn-secondary" type="button" onclick="clearSearch()">清除</button>
        </form>
        <div class="filter-box">
            <select id="downloadFilter" onchange="filterTable()">
                <option value="">所有状态</option>
                <option value="pending">待下载</option>
                <option value="processing">下载中</option>
                <option value="success">下载成功</option>
                <option value="failed">下载失败</option>
            </select>
        </div>
        <div class="filter-box">
            <select id="progressFilter" onchange="filterTable()">
                <option value="">所有进度</option>
                <option value="0">0%</option>
                <option value="25">1-25%</option>
                <option value="50">26-50%</option>
                <option value="75">51-75%</option>
                <option value="100">76-100%</option>
            </select>
        </div>
        <div class="filter-box">
            <select id="dateFilter" onchange="filterTable()">
                <option value="">所有日期</option>
                <option value="today">今天</option>
                <option value="week">本周</option>
                <option value="month">本月</option>
                <option value="quarter">本季度</option>
                <option value="year">今年</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="showAdvancedFilter()">
            <i class="fas fa-filter"></i> 高级筛选
        </button>
    </div>

    <!-- 高级筛选面板 -->
    <div id="advancedFilterPanel" class="advanced-filter-panel" style="display: none;">
        <div class="filter-row">
            <div class="filter-group">
                <label>开始日期范围：</label>
                <input type="date" id="startDateFrom" onchange="filterTable()">
                <span>至</span>
                <input type="date" id="startDateTo" onchange="filterTable()">
            </div>
            <div class="filter-group">
                <label>结束日期范围：</label>
                <input type="date" id="endDateFrom" onchange="filterTable()">
                <span>至</span>
                <input type="date" id="endDateTo" onchange="filterTable()">
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label>总记录数范围：</label>
                <input type="number" id="totalRecordsMin" placeholder="最小值" onchange="filterTable()">
                <span>至</span>
                <input type="number" id="totalRecordsMax" placeholder="最大值" onchange="filterTable()">
            </div>
            <div class="filter-group">
                <label>已下载记录数范围：</label>
                <input type="number" id="downloadedRecordsMin" placeholder="最小值" onchange="filterTable()">
                <span>至</span>
                <input type="number" id="downloadedRecordsMax" placeholder="最大值" onchange="filterTable()">
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label>错误信息包含：</label>
                <input type="text" id="errorFilter" placeholder="输入错误关键词" onkeyup="filterTable()">
            </div>
            <div class="filter-group">
                <label>排序方式：</label>
                <select id="sortBy" onchange="sortTable()">
                    <option value="id_desc">ID (降序)</option>
                    <option value="id_asc">ID (升序)</option>
                    <option value="stock_code_id">股票代码ID</option>
                    <option value="download_status">下载状态</option>
                    <option value="download_progress">下载进度</option>
                    <option value="start_date">开始日期</option>
                    <option value="end_date">结束日期</option>
                    <option value="created_at">创建时间</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="clearAdvancedFilter()">清除高级筛选</button>
            <button class="btn btn-primary" onclick="exportFilteredData()">导出筛选结果</button>
        </div>
    </div>

    <!-- 批量操作 -->
    <div class="batch-actions">
        <div class="batch-controls">
            <label>
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                全选
            </label>
            <span id="selectedCount">已选择 0 项</span>
        </div>
        <div class="batch-buttons">
            <button class="btn btn-warning" onclick="batchRetry()" disabled id="batchRetryBtn">
                <i class="fas fa-redo"></i> 批量重试
            </button>
            <button class="btn btn-danger" onclick="batchDelete()" disabled id="batchDeleteBtn">
                <i class="fas fa-trash"></i> 批量删除
            </button>
            <button class="btn btn-info" onclick="batchExport()" disabled id="batchExportBtn">
                <i class="fas fa-download"></i> 批量导出
            </button>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-title">总记录数</div>
            <div class="stat-value" id="totalRecords">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">待下载</div>
            <div class="stat-value pending" id="pendingCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">下载中</div>
            <div class="stat-value processing" id="processingCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">下载成功</div>
            <div class="stat-value success" id="successCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">下载失败</div>
            <div class="stat-value failed" id="failedCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">平均进度</div>
            <div class="stat-value" id="avgProgress">0%</div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="table-container">
        <table id="recordTable" class="data-table">
            <thead>
                <tr>
                    <th>选择</th>
                    <th>ID</th>
                    <th>股票代码ID</th>
                    <th>股票代码</th>
                    <th>股票名称</th>
                    <th>下载状态</th>
                    <th>下载进度</th>
                    <th>开始日期</th>
                    <th>结束日期</th>
                    <th>记录日期</th>
                    <th>总记录数</th>
                    <th>已下载记录数</th>
                    <th>最后下载时间</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr data-id="{{ record.id }}">
                    <td>
                        <input type="checkbox" class="record-checkbox" data-id="{{ record.id }}">
                    </td>
                    <td>{{ record.id }}</td>
                    <td>{{ record.stock_code_id }}</td>
                    <td>{{ record.stock_code or '-' }}</td>
                    <td>{{ record.stock_name or '-' }}</td>
                    <td>
                        <span class="status-badge status-{{ record.download_status }}">
                            {{ record.download_status }}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ record.download_progress }}%"></div>
                            <span class="progress-text">{{ record.download_progress }}%</span>
                        </div>
                    </td>
                    <td>{{ record.start_date.strftime('%Y-%m-%d') if record.start_date else '-' }}</td>
                    <td>{{ record.end_date.strftime('%Y-%m-%d') if record.end_date else '-' }}</td>
                    <td>{{ record.record_date.strftime('%Y-%m-%d') if record.record_date else '-' }}</td>
                    <td>{{ record.total_records }}</td>
                    <td>{{ record.downloaded_records }}</td>
                    <td>{{ record.last_download_time.strftime('%Y-%m-%d %H:%M') if record.last_download_time else '-' }}</td>
                    <td>{{ record.created_at.strftime('%Y-%m-%d %H:%M') if record.created_at else '-' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="editRecord({{ record.id }})" title="编辑">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="retryDownload({{ record.id }})" title="重试下载">
                                <i class="fas fa-redo"></i> 重试
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewDetails({{ record.id }})" title="查看详情">
                                <i class="fas fa-eye"></i> 查看
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord({{ record.id }})" title="删除">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    <div class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for('data_bp.record_stock_minute', page=pagination.prev_num, search=request.args.get('search', '')) }}" class="btn btn-secondary">上一页</a>
        {% endif %}

        <span class="page-info">第 {{ pagination.page }} 页，共 {{ pagination.pages }} 页</span>

        {% if pagination.has_next %}
            <a href="{{ url_for('data_bp.record_stock_minute', page=pagination.next_num, search=request.args.get('search', '')) }}" class="btn btn-secondary">下一页</a>
        {% endif %}
    </div>
</div>

<!-- 添加/编辑模态框，默认隐藏 -->
<div id="recordModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">添加股票分钟数据记录</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="recordForm" method="POST">
            <div class="form-row">
                <div class="form-group">
                    <label for="stock_code_id">股票代码ID *</label>
                    <input type="number" id="stock_code_id" name="stock_code_id" required>
                </div>
                <div class="form-group">
                    <label for="download_status">下载状态</label>
                    <select id="download_status" name="download_status">
                        <option value="pending">待下载</option>
                        <option value="processing">下载中</option>
                        <option value="success">下载成功</option>
                        <option value="failed">下载失败</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="download_progress">下载进度 (%)</label>
                    <input type="number" id="download_progress" name="download_progress" min="0" max="100" step="0.1" value="0.0">
                </div>
                <div class="form-group">
                    <label for="total_records">总记录数</label>
                    <input type="number" id="total_records" name="total_records" min="0" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="downloaded_records">已下载记录数</label>
                    <input type="number" id="downloaded_records" name="downloaded_records" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="last_download_time">最后下载时间</label>
                    <input type="datetime-local" id="last_download_time" name="last_download_time">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">开始日期</label>
                    <input type="date" id="start_date" name="start_date">
                </div>
                <div class="form-group">
                    <label for="end_date">结束日期</label>
                    <input type="date" id="end_date" name="end_date">
                </div>
            </div>
            <div class="form-group">
                <label for="record_date">记录日期</label>
                <input type="date" id="record_date" name="record_date">
            </div>
            <div class="form-group">
                <label for="error_message">错误信息</label>
                <textarea id="error_message" name="error_message" rows="3" placeholder="输入错误信息..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 删除确认模态框，默认隐藏 -->
<div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>确认删除</h2>
            <span class="close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>确定要删除这条记录吗？此操作不可撤销。</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
            <button class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
        </div>
    </div>
</div>

<style>
.container {
    width: 100%;
    max-width: none !important;
    margin: 0 !important;
    padding: 20px;
    box-sizing: border-box;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.header h1 {
    color: #1f2937;
    margin: 0;
}

.subtitle {
    color: #6b7280;
    margin: 5px 0 0 0;
}

.search-section {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    display: flex;
    gap: 10px;
    flex: 1;
    min-width: 300px;
}

.search-box input {
    flex: 1;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    max-width: 300px;
    min-width: 120px;
}

.filter-box select {
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    min-width: 120px;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow-x: auto;
    margin-bottom: 20px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1800px;
}

.data-table th,
.data-table td {
    padding: 10px 6px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    font-size: 12px;
    white-space: nowrap;
}

.data-table th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #374151;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table tr:hover {
    background-color: #f9fafb;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.status-pending {
    background-color: #fef3c7;
    color: #92400e;
}

.status-processing {
    background-color: #dbeafe;
    color: #1e40af;
}

.status-success {
    background-color: #d1fae5;
    color: #065f46;
}

.status-failed {
    background-color: #fee2e2;
    color: #991b1b;
}

.progress-bar {
    position: relative;
    width: 100%;
    height: 20px;
    background-color: #e5e7eb;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    transition: width 0.3s ease;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 500;
    color: #374151;
}

.actions {
    display: flex;
    gap: 5px;
    white-space: nowrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background-color: #4b5563;
}

.btn-info {
    background-color: #06b6d4;
    color: white;
}

.btn-warning {
    background-color: #f59e0b;
    color: white;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    color: #1f2937;
}

.close {
    color: #6b7280;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #374151;
}

.modal-body {
    padding: 20px;
}

.detail-row {
    display: flex;
    margin-bottom: 12px;
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 8px;
}

.detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.detail-row label {
    font-weight: 600;
    color: #374151;
    min-width: 120px;
    margin-right: 15px;
}

.detail-row span {
    color: #1f2937;
    flex: 1;
}

.status-pending {
    color: #92400e;
    font-weight: 600;
}

.status-processing {
    color: #1e40af;
    font-weight: 600;
}

.status-success {
    color: #065f46;
    font-weight: 600;
}

.status-failed {
    color: #991b1b;
    font-weight: 600;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #374151;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
}

.page-info {
    color: #6b7280;
    font-size: 14px;
}

@media (max-width: 1200px) {
    .container {
        padding: 15px;
    }
    
    .data-table {
        min-width: 1400px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .search-section {
        flex-direction: column;
        gap: 10px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .data-table {
        font-size: 11px;
        min-width: 1200px;
    }
    
    .data-table th,
    .data-table td {
        padding: 6px 4px;
    }
    
    .search-box input {
        max-width: 100%;
        min-width: 0;
    }
}

.advanced-filter-panel {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 15px;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-group label {
    font-weight: 500;
    color: #374151;
    min-width: 120px;
}

.filter-group input {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
}

.filter-group input[type="date"] {
    min-width: 140px;
}

.filter-group input[type="number"] {
    min-width: 100px;
}

.filter-group input[type="text"] {
    min-width: 150px;
}

.filter-group span {
    color: #6b7280;
    font-weight: 500;
}

.filter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #e5e7eb;
}

.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.stat-title {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 5px;
    font-weight: 500;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
}

.stat-value.pending {
    color: #92400e;
}

.stat-value.processing {
    color: #1e40af;
}

.stat-value.success {
    color: #065f46;
}

.stat-value.failed {
    color: #991b1b;
}

.batch-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.batch-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.batch-controls label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: #374151;
    cursor: pointer;
}

.batch-controls input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

#selectedCount {
    color: #6b7280;
    font-size: 14px;
}

.batch-buttons {
    display: flex;
    gap: 10px;
}

.batch-buttons .btn {
    padding: 8px 16px;
    font-size: 14px;
}

.batch-buttons .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-warning {
    background-color: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background-color: #d97706;
    border-color: #d97706;
}

.btn-danger {
    background-color: #dc2626;
    border-color: #dc2626;
    color: white;
}

.btn-danger:hover {
    background-color: #b91c1c;
    border-color: #b91c1c;
}

.btn-info {
    background-color: #0891b2;
    border-color: #0891b2;
    color: white;
}

.btn-info:hover {
    background-color: #0e7490;
    border-color: #0e7490;
}

.action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.action-buttons .btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-buttons .btn-sm i {
    font-size: 12px;
}

.btn-sm.btn-primary:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}
</style>

<script>
let currentRecordId = null;
let deleteRecordId = null;

function showAddModal() {
    document.getElementById('modalTitle').textContent = '添加股票分钟数据记录';
    document.getElementById('recordForm').action = "{{ url_for('data_bp.add_record_stock_minute') }}";
    document.getElementById('recordForm').reset();
    currentRecordId = null;
    document.getElementById('recordModal').style.display = 'block';
}

function editRecord(id) {
    fetch(`{{ url_for('data_bp.get_record_stock_minute', id=0) }}`.replace('0', id))
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalTitle').textContent = '编辑股票分钟数据记录';
            document.getElementById('recordForm').action = `{{ url_for('data_bp.edit_record_stock_minute', id=0) }}`.replace('0', id);
            
            document.getElementById('stock_code_id').value = data.stock_code_id || '';
            document.getElementById('download_status').value = data.download_status || 'pending';
            document.getElementById('download_progress').value = data.download_progress || 0.0;
            document.getElementById('total_records').value = data.total_records || 0;
            document.getElementById('downloaded_records').value = data.downloaded_records || 0;
            document.getElementById('start_date').value = data.start_date || '';
            document.getElementById('end_date').value = data.end_date || '';
            document.getElementById('record_date').value = data.record_date || '';
            document.getElementById('error_message').value = data.error_message || '';
            
            if (data.last_download_time) {
                const dt = new Date(data.last_download_time);
                const localDateTime = dt.toISOString().slice(0, 16);
                document.getElementById('last_download_time').value = localDateTime;
            } else {
                document.getElementById('last_download_time').value = '';
            }
            
            currentRecordId = id;
            document.getElementById('recordModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取记录信息失败');
        });
}

function viewRecord(id) {
    fetch(`{{ url_for('data_bp.get_record_stock_minute', id=0) }}`.replace('0', id))
        .then(response => response.json())
        .then(data => {
            const details = `
记录详情：
ID: ${data.id || '-'}
股票代码ID: ${data.stock_code_id || '-'}
下载状态: ${data.download_status || '-'}
下载进度: ${data.download_progress || 0}%
总记录数: ${data.total_records || 0}
已下载记录数: ${data.downloaded_records || 0}
开始日期: ${data.start_date || '-'}
结束日期: ${data.end_date || '-'}
记录日期: ${data.record_date || '-'}
最后下载时间: ${data.last_download_time || '-'}
创建时间: ${data.created_at || '-'}
更新时间: ${data.updated_at || '-'}
错误信息: ${data.error_message || '-'}
            `;
            alert(details);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取记录信息失败');
        });
}

function showDeleteModal(id) {
    deleteRecordId = id;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteRecordId = null;
}

function confirmDelete() {
    if (deleteRecordId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/data/record_stock_minute/delete/${deleteRecordId}`;
        document.body.appendChild(form);
        form.submit();
    }
    closeDeleteModal();
}

function deleteRecord(id) {
    showDeleteModal(id);
}

function closeModal() {
    document.getElementById('recordModal').style.display = 'none';
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const downloadFilter = document.getElementById('downloadFilter').value;
    const progressFilter = document.getElementById('progressFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const startDateFrom = document.getElementById('startDateFrom').value;
    const startDateTo = document.getElementById('startDateTo').value;
    const endDateFrom = document.getElementById('endDateFrom').value;
    const endDateTo = document.getElementById('endDateTo').value;
    const totalRecordsMin = document.getElementById('totalRecordsMin').value;
    const totalRecordsMax = document.getElementById('totalRecordsMax').value;
    const downloadedRecordsMin = document.getElementById('downloadedRecordsMin').value;
    const downloadedRecordsMax = document.getElementById('downloadedRecordsMax').value;
    const errorFilter = document.getElementById('errorFilter').value.toLowerCase();
    
    const table = document.getElementById('recordTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    let visibleCount = 0;
    const today = new Date();
    const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
    const yearStart = new Date(today.getFullYear(), 0, 1);

    for (let row of rows) {
        const stockCodeId = row.cells[2].textContent.toLowerCase();
        const stockCode = row.cells[3].textContent.toLowerCase();
        const stockName = row.cells[4].textContent.toLowerCase();
        const status = row.cells[5].textContent.trim();
        const progress = parseFloat(row.cells[6].querySelector('.progress-text').textContent);
        const startDate = row.cells[7].textContent;
        const endDate = row.cells[8].textContent;
        const totalRecords = parseInt(row.cells[10].textContent) || 0;
        const downloadedRecords = parseInt(row.cells[11].textContent) || 0;
        
        // 基础搜索匹配
        const matchesSearch = stockCodeId.includes(searchTerm) || stockCode.includes(searchTerm) || stockName.includes(searchTerm);
        
        // 下载状态匹配
        const matchesStatus = !downloadFilter || status === downloadFilter;
        
        // 进度匹配
        let matchesProgress = true;
        if (progressFilter) {
            const progressValue = parseInt(progressFilter);
            if (progressValue === 0) {
                matchesProgress = progress === 0;
            } else if (progressValue === 25) {
                matchesProgress = progress > 0 && progress <= 25;
            } else if (progressValue === 50) {
                matchesProgress = progress > 25 && progress <= 50;
            } else if (progressValue === 75) {
                matchesProgress = progress > 50 && progress <= 75;
            } else if (progressValue === 100) {
                matchesProgress = progress > 75 && progress <= 100;
            }
        }
        
        // 日期匹配
        let matchesDate = true;
        if (dateFilter && startDate !== '-') {
            const recordDate = new Date(startDate);
            if (dateFilter === 'today') {
                matchesDate = recordDate.toDateString() === today.toDateString();
            } else if (dateFilter === 'week') {
                matchesDate = recordDate >= weekStart;
            } else if (dateFilter === 'month') {
                matchesDate = recordDate >= monthStart;
            } else if (dateFilter === 'quarter') {
                matchesDate = recordDate >= quarterStart;
            } else if (dateFilter === 'year') {
                matchesDate = recordDate >= yearStart;
            }
        }
        
        // 高级筛选匹配
        let matchesAdvanced = true;
        
        // 开始日期范围
        if (startDateFrom && startDate !== '-') {
            matchesAdvanced = matchesAdvanced && startDate >= startDateFrom;
        }
        if (startDateTo && startDate !== '-') {
            matchesAdvanced = matchesAdvanced && startDate <= startDateTo;
        }
        
        // 结束日期范围
        if (endDateFrom && endDate !== '-') {
            matchesAdvanced = matchesAdvanced && endDate >= endDateFrom;
        }
        if (endDateTo && endDate !== '-') {
            matchesAdvanced = matchesAdvanced && endDate <= endDateTo;
        }
        
        // 总记录数范围
        if (totalRecordsMin) {
            matchesAdvanced = matchesAdvanced && totalRecords >= parseInt(totalRecordsMin);
        }
        if (totalRecordsMax) {
            matchesAdvanced = matchesAdvanced && totalRecords <= parseInt(totalRecordsMax);
        }
        
        // 已下载记录数范围
        if (downloadedRecordsMin) {
            matchesAdvanced = matchesAdvanced && downloadedRecords >= parseInt(downloadedRecordsMin);
        }
        if (downloadedRecordsMax) {
            matchesAdvanced = matchesAdvanced && downloadedRecords <= parseInt(downloadedRecordsMax);
        }
        
        const isVisible = matchesSearch && matchesStatus && matchesProgress && matchesDate && matchesAdvanced;
        row.style.display = isVisible ? '' : 'none';
        
        if (isVisible) {
            visibleCount++;
        }
    }
    
    updateStats();
}

function updateStats() {
    const table = document.getElementById('recordTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    let totalCount = 0;
    let pendingCount = 0;
    let processingCount = 0;
    let successCount = 0;
    let failedCount = 0;
    let totalProgress = 0;
    let progressCount = 0;
    
    for (let row of rows) {
        if (row.style.display !== 'none') {
            totalCount++;
            const status = row.cells[5].textContent.trim();
            const progress = parseFloat(row.cells[6].querySelector('.progress-text').textContent);
            
            switch (status) {
                case 'pending':
                    pendingCount++;
                    break;
                case 'processing':
                    processingCount++;
                    break;
                case 'success':
                    successCount++;
                    break;
                case 'failed':
                    failedCount++;
                    break;
            }
            
            totalProgress += progress;
            progressCount++;
        }
    }
    
    const avgProgress = progressCount > 0 ? Math.round(totalProgress / progressCount) : 0;
    
    document.getElementById('totalRecords').textContent = totalCount;
    document.getElementById('pendingCount').textContent = pendingCount;
    document.getElementById('processingCount').textContent = processingCount;
    document.getElementById('successCount').textContent = successCount;
    document.getElementById('failedCount').textContent = failedCount;
    document.getElementById('avgProgress').textContent = avgProgress + '%';
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('downloadFilter').value = '';
    document.getElementById('progressFilter').value = '';
    document.getElementById('dateFilter').value = '';
    clearAdvancedFilter();
}

function showAdvancedFilter() {
    const panel = document.getElementById('advancedFilterPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function clearAdvancedFilter() {
    document.getElementById('startDateFrom').value = '';
    document.getElementById('startDateTo').value = '';
    document.getElementById('endDateFrom').value = '';
    document.getElementById('endDateTo').value = '';
    document.getElementById('totalRecordsMin').value = '';
    document.getElementById('totalRecordsMax').value = '';
    document.getElementById('downloadedRecordsMin').value = '';
    document.getElementById('downloadedRecordsMax').value = '';
    document.getElementById('errorFilter').value = '';
    document.getElementById('sortBy').value = 'id_desc';
    filterTable();
}

function exportFilteredData() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('请选择要导出的记录');
        return;
    }
    
    // 构建导出URL，包含选中的ID
    const params = new URLSearchParams();
    params.append('selected_ids', selectedIds.join(','));
    
    const exportUrl = `/data/record_stock_minute/export?${params.toString()}`;
    window.location.href = exportUrl;
}

function sortTable() {
    const sortBy = document.getElementById('sortBy').value;
    const table = document.getElementById('recordTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (sortBy) {
            case 'id_desc':
                aValue = parseInt(a.cells[1].textContent);
                bValue = parseInt(b.cells[1].textContent);
                return bValue - aValue;
            case 'id_asc':
                aValue = parseInt(a.cells[1].textContent);
                bValue = parseInt(b.cells[1].textContent);
                return aValue - bValue;
            case 'stock_code_id':
                aValue = parseInt(a.cells[2].textContent);
                bValue = parseInt(b.cells[2].textContent);
                return aValue - bValue;
            case 'download_status':
                aValue = a.cells[5].textContent;
                bValue = b.cells[5].textContent;
                return aValue.localeCompare(bValue);
            case 'download_progress':
                aValue = parseFloat(a.cells[6].querySelector('.progress-text').textContent);
                bValue = parseFloat(b.cells[6].querySelector('.progress-text').textContent);
                return bValue - aValue;
            case 'start_date':
                aValue = a.cells[7].textContent;
                bValue = b.cells[8].textContent;
                return aValue.localeCompare(bValue);
            case 'end_date':
                aValue = a.cells[8].textContent;
                bValue = b.cells[8].textContent;
                return aValue.localeCompare(bValue);
            case 'created_at':
                aValue = a.cells[13].textContent;
                bValue = b.cells[13].textContent;
                return bValue.localeCompare(aValue);
            default:
                return 0;
        }
    });
    
    // 重新插入排序后的行
    rows.forEach(row => tbody.appendChild(row));
}

// 页面加载时初始化统计
document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    setupBatchOperations();
});

function setupBatchOperations() {
    // 为所有复选框添加事件监听器
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchButtons);
    });
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.record-checkbox');
    const isChecked = selectAllCheckbox.checked;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = isChecked;
        }
    });
    
    updateBatchButtons();
}

function updateBatchButtons() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    document.getElementById('selectedCount').textContent = `已选择 ${selectedCount} 项`;
    
    const batchRetryBtn = document.getElementById('batchRetryBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const batchExportBtn = document.getElementById('batchExportBtn');
    
    const hasSelection = selectedCount > 0;
    
    batchRetryBtn.disabled = !hasSelection;
    batchDeleteBtn.disabled = !hasSelection;
    batchExportBtn.disabled = !hasSelection;
}

function getSelectedIds() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    return Array.from(checkboxes).map(checkbox => checkbox.dataset.id);
}

function batchRetry() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('请选择要重试的记录');
        return;
    }
    
    if (confirm(`确定要重试选中的 ${selectedIds.length} 条记录吗？`)) {
        // 这里可以调用后端API进行批量重试
        alert('批量重试功能待实现');
    }
}

function batchDelete() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('请选择要删除的记录');
        return;
    }
    
    if (confirm(`确定要删除选中的 ${selectedIds.length} 条记录吗？此操作不可恢复！`)) {
        // 这里可以调用后端API进行批量删除
        alert('批量删除功能待实现');
    }
}

function batchExport() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('请选择要导出的记录');
        return;
    }
    
    // 构建导出URL，包含选中的ID
    const params = new URLSearchParams();
    params.append('selected_ids', selectedIds.join(','));
    
    const exportUrl = `/data/record_stock_minute/export?${params.toString()}`;
    window.location.href = exportUrl;
}

function retryDownload(id) {
    if (confirm('确定要重试下载这条记录吗？')) {
        // 这里可以调用后端API进行重试
        alert('重试下载功能待实现');
    }
}

function viewDetails(id) {
    // 获取记录详情并显示
    fetch(`/data/record_stock_minute/get/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // 显示详情模态框
            showDetailsModal(data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取详情失败');
        });
}

function showDetailsModal(data) {
    // 创建模态框显示详细信息
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>记录详情</h3>
                <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <label>ID:</label>
                    <span>${data.id}</span>
                </div>
                <div class="detail-row">
                    <label>股票代码ID:</label>
                    <span>${data.stock_code_id}</span>
                </div>
                <div class="detail-row">
                    <label>股票代码:</label>
                    <span>${data.stock_code || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>股票名称:</label>
                    <span>${data.stock_name || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>下载状态:</label>
                    <span class="status-${data.download_status}">${data.download_status}</span>
                </div>
                <div class="detail-row">
                    <label>下载进度:</label>
                    <span>${data.download_progress}%</span>
                </div>
                <div class="detail-row">
                    <label>总记录数:</label>
                    <span>${data.total_records}</span>
                </div>
                <div class="detail-row">
                    <label>已下载记录数:</label>
                    <span>${data.downloaded_records}</span>
                </div>
                <div class="detail-row">
                    <label>开始日期:</label>
                    <span>${data.start_date || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>结束日期:</label>
                    <span>${data.end_date || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>记录日期:</label>
                    <span>${data.record_date || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>最后下载时间:</label>
                    <span>${data.last_download_time || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>创建时间:</label>
                    <span>${data.created_at || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>更新时间:</label>
                    <span>${data.updated_at || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>错误信息:</label>
                    <span>${data.error_message || '-'}</span>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 点击模态框外部关闭
    modal.onclick = function(event) {
        if (event.target === modal) {
            modal.remove();
        }
    };
}

window.onclick = function(event) {
    const modal = document.getElementById('recordModal');
    const deleteModal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeModal();
    }
    if (event.target === deleteModal) {
        closeDeleteModal();
    }
}
</script>
{% endblock %}
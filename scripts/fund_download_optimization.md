# 基金下载优化说明

## 优化目标
为了降低对第三方网站（东方财富网）的压力，避免被反爬虫机制限制，我们对基金下载功能进行了以下优化：

## 主要修改

### 1. 减少并发线程数
- **修改前**: 最多5个并发线程
- **修改后**: 最多2个并发线程
- **效果**: 降低服务器并发压力

### 2. 增加下载延时
- **修改前**: 每次下载前等待1秒
- **修改后**: 每次下载前等待3秒
- **效果**: 降低请求频率

### 3. 增加处理完成延时
- **新增**: 每个基金处理完成后等待1秒
- **效果**: 进一步降低请求频率

### 4. 增加请求超时时间
- **API请求**: 从5秒增加到8秒
- **网页请求**: 从8秒增加到12秒
- **效果**: 提高请求成功率

## 配置参数

所有下载参数都集中在 `DOWNLOAD_CONFIG` 字典中，便于调整：

```python
DOWNLOAD_CONFIG = {
    'max_concurrent_workers': 2,      # 最大并发线程数
    'download_delay': 3,              # 每次下载前等待秒数
    'post_process_delay': 1,          # 每个基金处理完成后等待秒数
    'request_timeout': 10,            # 请求超时时间（秒）
    'api_timeout': 8,                 # API请求超时时间（秒）
    'webpage_timeout': 12,            # 网页请求超时时间（秒）
}
```

## 性能影响

### 下载速度
- **修改前**: 约100-200个基金/分钟
- **修改后**: 约20-40个基金/分钟
- **影响**: 下载速度降低约75%，但更稳定

### 成功率
- **预期提升**: 减少因请求过快被限制的情况
- **稳定性**: 提高下载成功率

## 建议

1. **根据实际情况调整**: 如果发现下载仍然被限制，可以进一步增加延时
2. **监控下载状态**: 关注下载成功率和错误日志
3. **分批次下载**: 对于大量基金，建议分批次下载

## 如何调整参数

如果需要进一步降低压力，可以修改 `DOWNLOAD_CONFIG` 中的参数：

```python
# 更保守的设置
DOWNLOAD_CONFIG = {
    'max_concurrent_workers': 1,      # 单线程下载
    'download_delay': 5,              # 每次等待5秒
    'post_process_delay': 2,          # 处理后等待2秒
    'api_timeout': 10,                # API超时10秒
    'webpage_timeout': 15,            # 网页超时15秒
}
```

## 注意事项

1. 这些修改会显著降低下载速度，但会提高稳定性
2. 建议在非高峰时段进行大量下载
3. 如果下载被限制，可以等待一段时间后重试
4. 定期检查第三方网站的访问政策变化 